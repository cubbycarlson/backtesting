<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.js"></script>

    <script src="./public/js/states.js"></script>
    <script src="./public/js/models.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./public/css/index.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">


    <style>
      div {
        display: inline-block;
      }
    </style>
  </head>

  <body>
    <div id="headerDiv">
      <a href="https:///www.covidactnow.org"><img id="headerImg" src="https://covidactnow.org/static/media/can_logo.0ac0983b.png"/></a>
      <h1 id="header">Covid Act Now Backtesting Tool</h1>
    </div>
    <form onsubmit="return false">
      <label for="states"></label>
      <select name="states" id="states">
        <option value="" selected disabled hidden>state</option>
        <!-- options go here -->
      </select>

      <label for="counties"></label>
      <select name="counties" disabled id="counties">
        <option value="" selected disabled hidden>counties</option>
        <!-- options go here -->
      </select>

      <label for="models"></label>
      <select id="models" disabled name="models" id="models">
        <option value="" selected disabled hidden>models</option>
        <!-- options go here -->
      </select>

      <label for="intervention"></label>
      <select id="intervention" name="intervention" id="intervention" disabled>
        <option value="" selected disabled hidden>intervention</option>
        <!-- options go here -->
      </select>

      <button class="btn" id="submitButton" disabled onClick="addData()">submit</button>
    </form>

    <div id="menu-outer">
      <h3 id="legendHeader">LEGEND: NOW SHOWING THE FOLLOWING MODELS FOR <span id="location"><i>NONE</i></span>:</h3>
      <div class="table">
        <ul id="legend">
          <!-- models go here -->
        </ul>
      </div>
    </div>

    <button class="btn" id="clearButton" onClick="emptyCharts()">clear all</button>

    <div class="chartContainer" width="800">
      <div class="canvasContainer" id="chartHospitalizationsContainer">
        <canvas id="hospitalizationsChart" width="450" height="450"></canvas>
      </div>
      <div class="canvasContainer" id="chartDeathContainer">
        <canvas id="deathChart" width="450" height="450"></canvas>
      </div>
    </div>

  </body>

  <script>

    Chart.defaults.global.defaultFontFamily = 'Source Code Pro';

    let trueDates = ["03-01-2020", "04-01-2020", "05-01-2020", "06-01-2020"];
    let actuals = [1,2,3,4]

    function cumulativeMaker(array) {
      let newArray = new Array(array.length)
      let oldArray = [...array].reverse();
      oldArray.forEach((value, index) => {
        let counter = 0;
        for (i = index; i < oldArray.length; i++) {
          counter += oldArray[i]
        }
        newArray[index] = counter
      })
      return newArray.reverse();
    }
    let cumulativeActuals = cumulativeMaker(actuals);

    const deathChart = document.getElementById("deathChart").getContext('2d');
    const hospitalizationsChart = document.getElementById("hospitalizationsChart").getContext('2d');

    function chartDefaults (titleText) {
      return {
        type: 'line',
        data: {
          labels: ["Mar 01", "Apr 01", "May 01", "Jun 01"],
          datasets: [{
              label: "Actual",
              backgroundColor: 'black',
              borderColor: "black",
              data: actuals,
              fill: false,
              spanGaps: true
            }, {
              label: "CAN 03-06-2020 LAX",
              backgroundColor: 'red',
              borderColor: 'red',
              data: [3,3,4,5],
              fill: false,
              spanGaps: true
            }, {
              label: "CAN 03-08-2020 STRICT",
              backgroundColor: 'blue',
              borderColor: 'blue',
              data: [2,5,7,5],
              fill: false,
              spanGaps: true
            },
            {
              label: "IHME 03-08-2020",
              backgroundColor: 'green',
              borderColor: 'green',
              data: [4,4,3,2],
              fill: false,
              spanGaps: true
            }]
        },
        options: {
          responsive: false,
          title: {
            display: true,
            text: titleText,
            // fontSize: "20px",
            fontSize: 15,
            fontColor: "#000000",
            fontStyle: "thin"
          },
          elements: {
              point:{
                  radius: 0,
                  hitRadius: 10
              }
          },
          scales: {
              xAxes: [{
                  scaleLabel: {
                      display: true,
                      labelString: "Date"
                  },
                  ticks: {
                      autoSkip: true,
                      autoSkipPadding: 20,
                      maxRotation: 0,
                      minRotation: 0,
                      fontSize: 13
                  },
                  gridLines: { display: false }

              }],
              yAxes: [{
                  scaleLabel: {
                      display: false,
                      // labelString: "Death (Total)"
                  }
              }]
          },
          legend: {
            position: "top",
            display: false
          },

          tooltips: {
            // mode: "index"
            enabled: false,
            custom: tooltip
          }
        }
      }
    }

    let death = new Chart(deathChart, chartDefaults("Deaths (Total)"))
    let hospitalizations = new Chart(hospitalizationsChart, chartDefaults("Hospitalizations (Daily)"))


    function tooltip (tooltipModel) {
      // Tooltip Element
      var tooltipEl = document.getElementById('chartjs-tooltip');

      // Create element on first render
      if (!tooltipEl) {
          tooltipEl = document.createElement('div');
          tooltipEl.id = 'chartjs-tooltip';
          tooltipEl.innerHTML = '<table></table>';
          document.body.appendChild(tooltipEl);
      }

      // Hide if no tooltip
      if (tooltipModel.opacity === 0) {
          tooltipEl.style.opacity = 0;
          return;
      }

      // Set caret Position
      tooltipEl.classList.remove('above', 'below', 'no-transform');
      if (tooltipModel.yAlign) {
          tooltipEl.classList.add(tooltipModel.yAlign);
      } else {
          tooltipEl.classList.add('no-transform');
      }

      function getBody(bodyItem) {
          return bodyItem.lines;
      }

      // Set Text
      if (tooltipModel.body) {
          var titleLines = tooltipModel.title || [];
          var bodyLines = tooltipModel.body.map(getBody);
          let bodyArray = bodyLines[0][0].replace(/\:/g, '').split(" ")
          let modelName = bodyArray[0]
          let value = Number(bodyArray[bodyArray.length - 1])
          bodyArray.pop();
          let modelString = bodyArray.join(" ");
          let datasets = this._data.datasets;
          let datasetIndex = tooltipModel.dataPoints[0].datasetIndex;
          let dataIndex = tooltipModel.dataPoints[0].index;
          let title = this._chart.chart.options.title.text;

          let dataset = datasets[datasetIndex].data;
          let cumulativeDataset = cumulativeMaker(dataset);

          var innerHtml = '<thead>';

          titleLines.forEach(function(title) {
              innerHtml += '<tr><th>' + title + "</br>" + modelString + '</th></tr>';
          });
          innerHtml += '</thead><tbody>';

          let valueTitles = [title + ": ", "Margin of Error: ", "Cumulative Margin of Error: "]
          let values = [value]; // index 0 is actual #
          values[1] = value - actuals[dataIndex]; // index 1 is MOE of that point
          values[2] = cumulativeDataset[dataIndex] - cumulativeActuals[dataIndex]; // index 2 is MOE cumulative

          values.forEach(function(value, index) {
              innerHtml +=
                '<tr><td>' +
                valueTitles[index] +
                value + '</td></tr>';
          });
          innerHtml += '</tbody>';

          var tableRoot = tooltipEl.querySelector('table');
          tableRoot.innerHTML = innerHtml;
      }

      // `this` will be the overall tooltip
      var position = this._chart.canvas.getBoundingClientRect();

      // Display, position, and set styles for font
      tooltipEl.style.opacity = 0.9;
      tooltipEl.style.position = 'absolute';
      tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
      tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
      tooltipEl.style.fontFamily = tooltipModel._bodyFontFamily;
      tooltipEl.style.fontSize = tooltipModel.bodyFontSize - 1 + 'px';
      tooltipEl.style.fontStyle = tooltipModel._bodyFontStyle;
      tooltipEl.style.padding = tooltipModel.yPadding + 'px ' + tooltipModel.xPadding + 'px';
      tooltipEl.style.pointerEvents = 'none';
      tooltipEl.style.backgroundColor = 'black';
      tooltipEl.style.color = 'white';
      tooltipEl.style.width = "250px"
      }

  </script>
</html>
