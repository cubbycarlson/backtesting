<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.js"></script>

    <script src="./public/js/states.js"></script>
    <script src="./public/js/models.js"></script>

    <style>
      div {
        display: inline-block;
      }
    </style>
  </head>

  <body>
    <form onsubmit="return false">
      <label for="states"></label>
      <select name="states" id="states">
        <option value="" selected disabled hidden>state</option>
        <!-- options go here -->
      </select>

      <label for="counties"></label>
      <select name="counties" id="counties">
        <option value="" selected disabled hidden>counties</option>
        <!-- options go here -->
      </select>

      <label for="models"></label>
      <select disabled name="models" id="models">
        <option value="" selected disabled hidden>models</option>
        <!-- options go here -->
      </select>

      <label for="intervention"></label>
      <select name="intervention" id="intervention" disabled>
        <option value="" selected disabled hidden>intervention</option>
        <!-- options go here -->
      </select>

      <button id="submitButton" disabled onClick="addData()">submit</button>
    </form>

    <ul id="legend">
      <lh>LEGEND: NOW SHOWING THE FOLLOWING MODELS FOR <span id="location">NONE</span>:</lh>
      <!-- models go here -->
      <!-- <li>lol</li> -->
    </ul>

    </br>
    <button id="clearButton" onClick="emptyCharts()">clear all</button>
    </br>
    </br>


    <div class="chartsContainer">
      <div class="chartContainer" width="800">
        <div class="chartDeathContainer">
          <canvas id="deathChart" width="500" height="500"></canvas>
        </div>
        <div class="chartHospitalizationsContainer">
          <canvas id="hospitalizationsChart" width="500" height="500"></canvas>
        </div>
      </div>
    </div>

  </body>

  <script>
    let statesSelect = document.getElementById("states");
    let countiesSelect = document.getElementById("counties");
    let modelsSelect = document.getElementById("models");
    let interventionSelect = document.getElementById("intervention");
    let submitButton = document.getElementById("submitButton");
    let interventions = ["NONE", "LAX", "PREDICTED", "STRICT"]


    var stateOption = document.createElement("OPTION");
    stateOption.label = "(United States)";
    stateOption.text = "US";
    statesSelect.append(stateOption)

    for (state in states) {
      stateOption = document.createElement("OPTION");
      stateOption.label = states[state];
      stateOption.text = state;
      statesSelect.append(stateOption)
    }

    let fipsUrl = "https://raw.githubusercontent.com/kjhealy/fips-codes/master/state_and_county_fips_master.csv"

    function removeOptions(selectElement) {
       var i, L = selectElement.options.length - 1;
       for(i = L; i >= 1; i--) {
          selectElement.remove(i);
       }
    }

    let levels = ["country", "state", "county"]
    let levelIndex = 0;

    let fips = {}
    fetch(fipsUrl).then(data => data.text())
      .then(text => {
        let lines = text.split("\n");
        lines = lines
          .map(a => a.replace("\r", ""))
          .map(b => b.split(","))
          .filter(c => { if (c[2] != "NA") return c })
        for (state in states) {
          fips[state] = []
          lines.forEach(line => {
            if (line[2] == state) fips[state].push({ name: line[1], fips: line[0] })
          })
        }
      }).catch(err => console.log(err))

    // add in missing fips["46102"] = []; // Oglala County, South Dakota


    let modelsToShow = [];

    statesSelect.addEventListener("change", (event) => {
      removeOptions(countiesSelect)
      removeOptions(modelsSelect)
      modelsSelect.disabled = true;
      interventionSelect.disabled = true;
      submitButton.disabled = true;

      selectedState = statesSelect.value;
      if (selectedState == "US") {
        countiesSelect.disabled = true;
        modelsSelect.disabled = false;
        levelIndex = 0
        // add USA models
        modelsToShow = [];
        models.forEach(model => {
          if (model.countryLevel) {
            model.dates.forEach(commitDate => {
              modelsToShow.push({
                name: model.name.toUpperCase(),
                folderName: model.folderName,
                displayName: model.displayName,
                commitDate: commitDate
              })
            })
          }
        })

        modelsToShow.forEach((modelAvailable, index) => {
            let modelOption = document.createElement("OPTION");
            modelOption.label = modelAvailable.name + " " + modelAvailable.commitDate;
            modelOption.text = index;
            modelsSelect.append(modelOption)
        })

      } else {
        countiesSelect.disabled = false;

        var countyOption = document.createElement("OPTION");
        countyOption.label = "(all)";
        countyOption.text = -1;
        countiesSelect.append(countyOption)

        fips[statesSelect.value].forEach(county => {
          countyOption = document.createElement("OPTION");
          countyOption.label = county.name;
          countyOption.text = county.fips;
          countiesSelect.append(countyOption)
        })
      }
    })

    countiesSelect.addEventListener("change", (event) => {
      removeOptions(modelsSelect);
      modelsSelect.disabled = false;
      interventionSelect.disabled = true;
      submitButton.disabled = true;
      let fipsValue = Number(countiesSelect.value);

      if (fipsValue == -1) {
        levelIndex = 1;
        // add state models
        modelsToShow = [];
        models.forEach(model => {
          if (model.stateLevel) {
            model.dates.forEach(commitDate => {
              modelsToShow.push({
                name: model.name.toUpperCase(),
                folderName: model.folderName,
                displayName: model.displayName,
                commitDate: commitDate
              })
            })
          }
        })

        modelsToShow.forEach((modelAvailable, index) => {
            let modelOption = document.createElement("OPTION");
            modelOption.label = modelAvailable.name + " " + modelAvailable.commitDate;
            modelOption.text = index;
            modelsSelect.append(modelOption)
        })
      } else {
        levelIndex = 2;
        // add county models
        modelsToShow = [];
        models.forEach(model => {
          if (model.countyLevel) {
            model.dates.forEach(commitDate => {
              modelsToShow.push({
                name: model.name.toUpperCase(),
                folderName: model.folderName,
                displayName: model.displayName,
                commitDate: commitDate
              })
            })
          }
        })

        modelsToShow.forEach((modelAvailable, index) => {
            let modelOption = document.createElement("OPTION");
            modelOption.label = modelAvailable.name + " " + modelAvailable.commitDate;
            modelOption.text = index;
            modelsSelect.append(modelOption)
        })
      }
    })

    modelsSelect.addEventListener("change", (event) => {
      removeOptions(interventionSelect);
      if (modelsToShow[modelsSelect.value].name == "CAN") {
        interventionSelect.disabled = false;

        interventions.forEach((intervention, index) => {
          let interventionOption = document.createElement("OPTION");
          interventionOption.value = index;
          interventionOption.label = intervention
          if (!(index == 2 && modelsToShow[modelsSelect.value].commitDate < "04-14-20")) interventionSelect.append(interventionOption)
        })


      } else {
        interventionSelect.disabled = true;
        submitButton.disabled = false;
      }
    })

    interventionSelect.addEventListener("change", (event) => {
      submitButton.disabled = false;
    });

    const deathChart = document.getElementById("deathChart").getContext('2d');
    const hospitalizationsChart = document.getElementById("hospitalizationsChart").getContext('2d');

    function chartDefaults (titleText) {
      return {
        type: 'line',
        data: {
          labels: ["Mar 01", "Apr 01", "May 01", "Jun 01"],
          datasets: []
        },
        options: {
          responsive: false,
          title: {
            display: true,
            text: titleText
          },
          scales: {
              xAxes: [{
                  scaleLabel: {
                      display: true,
                      labelString: "Date"
                  },
                  ticks: {
                      autoSkip: true,
                      autoSkipPadding: 20,
                      maxRotation: 0,
                      minRotation: 0,
                      fontSize: 13
                  },
                  gridLines: { display: false }

              }],
              yAxes: [{
                  scaleLabel: {
                      display: false,
                      // labelString: "Death (Total)"
                  }
              }]
          },
          legend: {
            position: "top",
            display: false
          },

          tooltips: {
            mode: "index"
          }
        }
      }
    }

    let death = new Chart(deathChart, chartDefaults("Deaths (Total)"))
    let hospitalizations = new Chart(hospitalizationsChart, chartDefaults("Hospitalizations (Daily)"))

    function getJson(folderName, commit, state, intervention, fips = null) {
      let url = '/public/data/' + folderName + "/" + commit + '/' + state + '.json'
      if (folderName == "projections") url = '/public/data/' + folderName + "/" + commit + '/' + intervention + '/' + state  + '.json'
      if (folderName == "actual") url = '/public/data/actual/' + state  + '.json'
      if (folderName == "actual/fips") url = '/public/data/actual/fips/' + fips  + '.json' // state is

      console.log("fetching", url)
      return fetch(url).then(data => data.json())
    }

    function pullData (folderName, commit, state, intervention, fips = null) {
      return Promise.all([getJson(folderName, commit, state, intervention, fips)]);
    }

    let firstSubmission = true;
    let listIndex = 1;

    function addData() {
      console.log(
        "state:",
        statesSelect.value, // state abbreviation or "US"
        "fips:",
        countiesSelect.value, // fips or -1 for (all)
        "model:",
        modelsToShow[modelsSelect.value], // model object
        "intervention:",
        interventionSelect.value // index value
      )

      if (firstSubmission) {
        firstSubmission = false;
        if (statesSelect.value == "US") { // USA selected
          document.getElementById("location").innerHTML = "UNITED STATES"
          pullData("actual", null, "US", null)
            .then(act => {
              let datesArray = act[0].map(row => row.date)
              let deathArray = act[0].map(row => row.death)
              let hospArray = act[0].map(row => row.hospitalizations)

              death.options.title.text = "United States Deaths (Total)";
              hospitalizations.options.title.text = "United States Hospitalizations (Daily)"

              death.data.labels = datesArray;
              hospitalizations.data.labels = datesArray;
              death.data.datasets.push({
                label: "Actual",
                backgroundColor: "black",
                borderColor: "black",
                data: deathArray,
                fill: false,
                spanGaps: true
              });
              death.update();
              hospitalizations.data.datasets.push({
                label: "Actual",
                backgroundColor: "black",
                borderColor: "black",
                data: hospArray,
                fill: false,
                spanGaps: true
              });
              hospitalizations.update();

              let model = modelsToShow[modelsSelect.value]
              pullData(model.folderName, model.commitDate, "US", interventionSelect.value)
                .then(data => {

                  let deathArray = new Array(death.data.labels.length);
                  let hospArray = new Array(hospitalizations.data.labels.length);

                  death.data.labels.forEach((label, index) => {
                    data[0].forEach(row => {
                      if (row.date == label && row.date >= model.commitDate) {
                        deathArray[index] = Math.round(row.death);
                        hospArray[index] = Math.round(row.hospitalizations);
                      }
                    })
                  })

                  let selectedIntervention = interventions[interventionSelect.value];
                  if (selectedIntervention == undefined) selectedIntervention = ""
                  let label = model.name + " " + model.commitDate + " " + selectedIntervention;

                  death.data.datasets.push({
                    label: label,
                    backgroundColor: "black",
                    borderColor: "black",
                    data: deathArray,
                    fill: false,
                    spanGaps: true
                  });
                  death.update();

                  hospitalizations.data.datasets.push({
                    label: label,
                    backgroundColor: "black",
                    borderColor: "black",
                    data: hospArray,
                    fill: false,
                    spanGaps: true
                  });
                  hospitalizations.update();
                  addModelToLegend(label, listIndex)

                })
            }).catch(err => console.log(err))
        } else if (countiesSelect.value == -1) { // state selected

          let state = statesSelect.value;
          document.getElementById("location").innerHTML = states[state].toUpperCase();

          // function pullData (folderName, commit, state, intervention)

          pullData("actual", null, state, null)
            .then(act => {
              let datesArray = act[0].map(row => row.date)
              let deathArray = act[0].map(row => row.death)
              let hospArray = act[0].map(row => row.hospitalizations)

              death.options.title.text = states[state] + " Deaths (Total)";
              hospitalizations.options.title.text = states[state] + " Hospitalizations (Daily)"

              death.data.labels = datesArray;
              hospitalizations.data.labels = datesArray;
              death.data.datasets.push({
                label: "Actual",
                backgroundColor: "black",
                borderColor: "black",
                data: deathArray,
                fill: false,
                spanGaps: true
              });
              death.update();
              hospitalizations.data.datasets.push({
                label: "Actual",
                backgroundColor: "black",
                borderColor: "black",
                data: hospArray,
                fill: false,
                spanGaps: true
              });
              hospitalizations.update();

              let model = modelsToShow[modelsSelect.value]

              pullData(model.folderName, model.commitDate, state, interventionSelect.value)
                .then(data => {

                  let deathArray = new Array(death.data.labels.length);
                  let hospArray = new Array(hospitalizations.data.labels.length);

                  death.data.labels.forEach((label, index) => {
                    data[0].forEach(row => {
                      if (row.date == label && row.date >= model.commitDate) {
                        deathArray[index] = Math.round(row.death);
                        hospArray[index] = Math.round(row.hospitalizations);
                      }
                    })
                  })

                  let selectedIntervention = interventions[interventionSelect.value];
                  if (selectedIntervention == undefined) selectedIntervention = ""
                  let label = model.name + " " + model.commitDate + " " + selectedIntervention;

                  death.data.datasets.push({
                    label: label,
                    backgroundColor: "black",
                    borderColor: "black",
                    data: deathArray,
                    fill: false,
                    spanGaps: true
                  });
                  death.update();

                  hospitalizations.data.datasets.push({
                    label: label,
                    backgroundColor: "black",
                    borderColor: "black",
                    data: hospArray,
                    fill: false,
                    spanGaps: true
                  });
                  hospitalizations.update();

                  addModelToLegend(label, listIndex)


                })
            }).catch(err => console.log(err))

        } else { // county selected

          let fipsSelected = countiesSelect.value;
          let state = statesSelect.value;
          let countyName = "";

          fips[state].forEach(county => {
            if (county.fips == fipsSelected) {
              countyName = county.name;
              document.getElementById("location").innerHTML = county.name.toUpperCase();
            }
          })

          pullData("actual/fips", null, null, null, fipsSelected)
            .then(act => {
              let datesArray = act[0].map(row => row.date)
              let deathArray = act[0].map(row => row.death)
              // let hospArray = act[0].map(row => row.cases)
              let hospArray = []

              death.options.title.text = countyName + " Deaths (Total)";
              hospitalizations.options.title.text = countyName + " Hospitalizations (Daily)"

              death.data.labels = datesArray;
              hospitalizations.data.labels = datesArray;
              death.data.datasets.push({
                label: "Actual",
                backgroundColor: "black",
                borderColor: "black",
                data: deathArray,
                fill: false,
                spanGaps: true
              });
              death.update();
              hospitalizations.data.datasets.push({
                label: "Actual",
                backgroundColor: "black",
                borderColor: "black",
                data: hospArray,
                fill: false,
                spanGaps: true
              });
              hospitalizations.update();

              let model = modelsToShow[modelsSelect.value]

              fetch("https://data.covidactnow.org/latest/us/counties.WEAK_INTERVENTION.timeseries.csv")
                .then(data => data.text())
                .then(csv => {
                  console.log(csv)
                })

              // pullData(model.folderName, model.commitDate, state, interventionSelect.value)
              //   .then(data => {
              //
              //     let deathArray = new Array(death.data.labels.length);
              //     let hospArray = new Array(hospitalizations.data.labels.length);
              //
              //     death.data.labels.forEach((label, index) => {
              //       data[0].forEach(row => {
              //         if (row.date == label && row.date >= model.commitDate) {
              //           deathArray[index] = Math.round(row.death);
              //           hospArray[index] = Math.round(row.hospitalizations);
              //         }
              //       })
              //     })
              //
              //     let selectedIntervention = interventions[interventionSelect.value];
              //     if (selectedIntervention == undefined) selectedIntervention = ""
              //     let label = model.name + " " + model.commitDate + " " + selectedIntervention;
              //
              //     death.data.datasets.push({
              //       label: label,
              //       backgroundColor: "black",
              //       borderColor: "black",
              //       data: deathArray,
              //       fill: false,
              //       spanGaps: true
              //     });
              //     death.update();
              //
              //     hospitalizations.data.datasets.push({
              //       label: label,
              //       backgroundColor: "black",
              //       borderColor: "black",
              //       data: hospArray,
              //       fill: false,
              //       spanGaps: true
              //     });
              //     hospitalizations.update();
              //
              //     addModelToLegend(label, listIndex)
              //
              //
              //   })
            }).catch(err => console.log(err))




















        }
      } else {
        firstSubmission = false;
        if (statesSelect.value == "US") { // USA selected
            let model = modelsToShow[modelsSelect.value]
            pullData(model.folderName, model.commitDate, "US", interventionSelect.value)
              .then(data => {
                let deathArray = new Array(death.data.labels.length);
                let hospArray = new Array(hospitalizations.data.labels.length);

                death.data.labels.forEach((label, index) => {
                  data[0].forEach(row => {
                    if (row.date == label && row.date >= model.commitDate) {
                      deathArray[index] = Math.round(row.death);
                      hospArray[index] = Math.round(row.hospitalizations);
                    }
                  })
                })

                let selectedIntervention = interventions[interventionSelect.value];
                if (selectedIntervention == undefined) selectedIntervention = "";
                let label = model.name + " " + model.commitDate + " " + selectedIntervention;

                death.data.datasets.push({
                  label: label,
                  backgroundColor: "black",
                  borderColor: "black",
                  data: deathArray,
                  fill: false,
                  spanGaps: true
                });
                death.update();

                hospitalizations.data.datasets.push({
                  label: label,
                  backgroundColor: "black",
                  borderColor: "black",
                  data: hospArray,
                  fill: false,
                  spanGaps: true
                });
                hospitalizations.update();
                addModelToLegend(label, listIndex)

              })
        } else if (countiesSelect.value == -1) { // state selected

          let state = statesSelect.value;

          let model = modelsToShow[modelsSelect.value]

          pullData(model.folderName, model.commitDate, state, interventionSelect.value)
            .then(data => {

              let deathArray = new Array(death.data.labels.length);
              let hospArray = new Array(hospitalizations.data.labels.length);

              death.data.labels.forEach((label, index) => {
                data[0].forEach(row => {
                  if (row.date == label && row.date >= model.commitDate) {
                    deathArray[index] = Math.round(row.death);
                    hospArray[index] = Math.round(row.hospitalizations);
                  }
                })
              })

              let selectedIntervention = interventions[interventionSelect.value];
              if (selectedIntervention == undefined) selectedIntervention = "";
              let label = model.name + " " + model.commitDate + " " + selectedIntervention;

              death.data.datasets.push({
                label: label,
                backgroundColor: "black",
                borderColor: "black",
                data: deathArray,
                fill: false,
                spanGaps: true
              });
              death.update();

              hospitalizations.data.datasets.push({
                label: label,
                backgroundColor: "black",
                borderColor: "black",
                data: hospArray,
                fill: false,
                spanGaps: true
              });
              hospitalizations.update();
              addModelToLegend(label, listIndex)

            })


        } else { // county selected
          let fipsSelected = countiesSelect.value;
          let state = statesSelect.value;
          let countyName = "";

          fips[state].forEach(county => {
            if (county.fips == fipsSelected) document.getElementById("location").innerHTML = county.name.toUpperCase();
          })

          // load county data onto graph here (not first submission)

        }

      }

    }

    function addModelToLegend(name, index) {
      var ul = document.getElementById("legend");
      var li = document.createElement("li");
      li.appendChild(document.createTextNode(name));
      li.setAttribute("id", index); // added line
      ul.appendChild(li);
      listIndex++
    }

    function emptyChart(chart) {
      // TO DO reset selects & buttons here too!
      firstSubmission = true;
      if (chart == death) {
        chart.options.title.text = "Deaths (Total)";
      } else if (chart == hospitalizations) {
        chart.options.title.text = "Hospitalizations (Total)";
      }

      chart.data.labels = ['Mar 01', 'Apr 01', 'May 01', 'Jun 01'];
      chart.data.datasets = [];
      chart.update();

      document.getElementById("location").innerHTML = "NONE";
    }

    function emptyCharts() {
      emptyChart(death)
      emptyChart(hospitalizations)
    }

  </script>
</html>
