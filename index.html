<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.js"></script>

    <script src="./public/js/states.js"></script>
    <script src="./public/js/models.js"></script>
    <script src="./public/js/dateToCommit.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./public/css/index.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">


    <style>
      div {
        display: inline-block;
      }
    </style>
  </head>

  <body>
    <div id="headerDiv">
      <a href="https:///www.covidactnow.org"><img id="headerImg" src="https://covidactnow.org/static/media/can_logo.0ac0983b.png"/></a>
      <h1 id="header">Covid Act Now Backtesting Tool</h1>
    </div>
    <form onsubmit="return false">
      <label for="states"></label>
      <select name="states" id="states">
        <option value="" selected disabled hidden>state</option>
        <!-- options go here -->
      </select>

      <label for="counties"></label>
      <select name="counties" disabled id="counties">
        <option value="" selected disabled hidden>counties</option>
        <!-- options go here -->
      </select>

      <label for="models"></label>
      <select id="models" disabled name="models" id="models">
        <option value="" selected disabled hidden>models</option>
        <!-- options go here -->
      </select>

      <label for="intervention"></label>
      <select id="intervention" name="intervention" id="intervention" disabled>
        <option value="" selected disabled hidden>intervention</option>
        <!-- options go here -->
      </select>

      <button class="btn" id="submitButton" disabled onClick="addData()">submit</button>
    </form>

    <div id="menu-outer">
      <h3 id="legendHeader">LEGEND: <span id="location"></span></h3>
      <div class="table">
        <ul id="legend">
          <!-- models go here -->
        </ul>
      </div>
    </div>

    <button class="btn" id="clearButton" onClick="emptyCharts()">reset</button>
    <button class="btn" id="downloadCsv" onClick="downloadCsv()">download csv</button>
    <p id="errorMessage"></p>

    <div class="chartContainer" width="800">
      <div class="canvasContainer" id="chartHospitalizationsContainer">
        <canvas id="hospitalizationsChart" width="450" height="450"></canvas>
      </div>
      <div class="canvasContainer" id="chartDeathContainer">
        <canvas id="deathChart" width="450" height="450"></canvas>
      </div>
    </div>

  </body>

  <script>

    Chart.defaults.global.defaultFontFamily = 'Source Code Pro';
    let colors = [
      "#000000", // BLACK
      "#00d07d", // GREEN
      "#ff6b2f", // YELLOW
      "#d317dc", // MAGENTA
      "#008f6c", // ORANGE
      "#60bae1", // BLUE
      "#ff9c00", // GOLD
      "#e12638", // RED
      "#8800ff", // PURPLE
      // "f5f5f5", // LIGHT GREY
      // "ffffff" // WHITE
    ];
    let colorIndex = 0;
    function nextColor() {
      colorIndex++;
      if (colorIndex >= colors.length) {
        colorIndex = 0
      }
    }

    let statesSelect = document.getElementById("states");
    let countiesSelect = document.getElementById("counties");
    let modelsSelect = document.getElementById("models");
    let interventionSelect = document.getElementById("intervention");
    let submitButton = document.getElementById("submitButton");
    let interventions = ["NONE", "STRICT", "PREDICTED", "LAX"];

    let canApiInterventions = [
      "NO_INTERVENTION",
      "STRONG_INTERVENTION",
      "OBSERVED_INTERVENTION",
      "WEAK_INTERVENTION"
    ]

    function addLeadingZero(fipsString) {
      if (fipsString.length == 4) return "0" + fipsString
      return fipsString
    }

    function parseDate (strDate) {
      // strDate is format "YYYY-MM-DD", return "MM-DD-YYYY"
      let str = strDate.toString();
      let year = str.slice(0,4);
      let month = str.slice(5,7);
      let day = str.slice(8,10);
      return month + "-" + day + "-" + year
    }

    function convertDates (dates) {
      return dates.map(date => {
        let month = date.substring(0,2)
        let months = {
          "01": "Jan",
          "02": "Feb",
          "03": "Mar",
          "04": "Apr",
          "05": "May",
          "06": "Jun",
          "07": "Jul",
          "08": "Aug",
          "09": "Sep",
          "10": "Oct",
          "11": "Nov",
          "12": "Dec"
        }
        return months[month] + " " + date.substring(3,5)
      })
    }

    function cumulativeMaker(array, startIndex = 0) {
      let oldArray = [...array].slice(startIndex, array.length).reverse();
      let newArray = new Array(oldArray.length)
      oldArray.forEach((value, index) => {
        let counter = 0;
        for (i = index; i < oldArray.length; i++) {
          // console.log(oldArray[i], "HERE");
          if (oldArray[i] != undefined && oldArray[i]) counter += oldArray[i]
        }
        newArray[index] = counter
      })
      if (startIndex > 0) {
        let starterArray = new Array(startIndex).fill(0);
        return starterArray.concat(newArray.reverse());
      } else {
        return newArray.reverse();
      }
    }

    let errMsg = "SORRY, THERE IS NO DATA AVAIABLE FOR YOUR SELECTION";
    let errorMessage = document.getElementById("errorMessage");

    let trueDates = [];

    var stateOption = document.createElement("OPTION");
    stateOption.label = "(United States)";
    stateOption.text = "US";
    statesSelect.append(stateOption)

    for (state in states) {
      stateOption = document.createElement("OPTION");
      stateOption.label = states[state];
      stateOption.text = state;
      statesSelect.append(stateOption)
    }

    let fipsUrl = "https://raw.githubusercontent.com/kjhealy/fips-codes/master/state_and_county_fips_master.csv"

    function removeOptions(selectElement) {

       var i, L = selectElement.options.length - 1;
       for(i = L; i >= 1; i--) {
          selectElement.remove(i);
       }
    }

    let levels = ["country", "state", "county"]
    let levelIndex = 0;

    let fips = {}
    fetch(fipsUrl).then(data => data.text())
      .then(text => {
        let lines = text.split("\n");
        lines = lines
          .map(a => a.replace("\r", ""))
          .map(b => b.split(","))
          .filter(c => { if (c[2] != "NA") return c })
        for (state in states) {
          fips[state] = []
          lines.forEach(line => {
            if (line[2] == state) fips[state].push({ name: line[1], fips: line[0] })
          })
        }
      }).catch(err => console.log(err))

    // add in missing fips["46102"] = []; // Oglala County, South Dakota


    let modelsToShow = [];

    statesSelect.addEventListener("change", (event) => {
      removeOptions(countiesSelect);
      removeOptions(modelsSelect);
      statesSelect.disabled = true;
      modelsSelect.disabled = true;
      interventionSelect.disabled = true;
      submitButton.disabled = true;

      selectedState = statesSelect.value;

      if (selectedState == "US") {
        countiesSelect.disabled = true;
        modelsSelect.disabled = false;
        levelIndex = 0
        // add USA models
        modelsToShow = [];
        models.forEach(model => {
          if (model.countryLevel) {
            model.dates.forEach(commitDate => {
              modelsToShow.push({
                name: model.name.toUpperCase(),
                folderName: model.folderName,
                displayName: model.displayName,
                commitDate: commitDate
              })
            })
          }
        })

        modelsToShow.forEach((modelAvailable, index) => {
            let modelOption = document.createElement("OPTION");
            modelOption.label = modelAvailable.name + " " + modelAvailable.commitDate;
            modelOption.text = index;
            modelsSelect.append(modelOption)
        })

      } else {
        countiesSelect.disabled = false;

        var countyOption = document.createElement("OPTION");
        countyOption.label = "(all)";
        countyOption.text = -1;
        countiesSelect.append(countyOption)

        fips[statesSelect.value].forEach(county => {
          countyOption = document.createElement("OPTION");
          countyOption.label = county.name;
          countyOption.text = county.fips;
          countiesSelect.append(countyOption)
        })
      }
    })

    countiesSelect.addEventListener("change", (event) => {
      removeOptions(modelsSelect);
      modelsSelect.disabled = false;
      interventionSelect.disabled = true;
      submitButton.disabled = true;
      let fipsValue = Number(countiesSelect.value);

      if (fipsValue == -1) {
        levelIndex = 1;
        // add state models
        modelsToShow = [];
        models.forEach(model => {
          if (model.stateLevel) {
            model.dates.forEach(commitDate => {
              modelsToShow.push({
                name: model.name.toUpperCase(),
                folderName: model.folderName,
                displayName: model.displayName,
                commitDate: commitDate
              })
            })
          }
        })

        modelsToShow.forEach((modelAvailable, index) => {
            let modelOption = document.createElement("OPTION");
            modelOption.label = modelAvailable.name + " " + modelAvailable.commitDate;
            modelOption.text = index;
            modelsSelect.append(modelOption)
        })
      } else {
        levelIndex = 2;
        // add county models
        modelsToShow = [];
        models.forEach(model => {
          if (model.countyLevel) {
            model.dates.forEach(commitDate => {
              if (commitDate >= "05-06-2020") {
                modelsToShow.push({
                  name: model.name.toUpperCase(),
                  folderName: model.folderName,
                  displayName: model.displayName,
                  commitDate: commitDate
                })
              }
            })
          }
        })

        modelsToShow.forEach((modelAvailable, index) => {
            let modelOption = document.createElement("OPTION");
            modelOption.label = modelAvailable.name + " " + modelAvailable.commitDate;
            modelOption.text = index;
            modelsSelect.append(modelOption)
        })
      }
    })

    modelsSelect.addEventListener("change", (event) => {
      removeOptions(interventionSelect);
      if (modelsToShow[modelsSelect.value].name == "CAN") {
        interventionSelect.disabled = false;

        interventions.forEach((intervention, index) => {
          let interventionOption = document.createElement("OPTION");
          interventionOption.value = index;
          interventionOption.label = intervention
          if (!(index == 2 && modelsToShow[modelsSelect.value].commitDate < "04-14-20")) interventionSelect.append(interventionOption)
        })


      } else {
        interventionSelect.disabled = true;
        submitButton.disabled = false;
      }
    })

    interventionSelect.addEventListener("change", (event) => {
      submitButton.disabled = false;
    });

    const deathChart = document.getElementById("deathChart").getContext('2d');
    const hospitalizationsChart = document.getElementById("hospitalizationsChart").getContext('2d');

    function chartDefaults (titleText) {
      return {
        type: 'line',
        data: {
          labels: ["Mar 01", "Apr 01", "May 01", "Jun 01"],
          datasets: []
        },
        options: {
          responsive: false,
          title: {
            display: true,
            text: titleText,
            // fontSize: "20px",
            fontSize: 15,
            fontColor: "#000000",
            fontStyle: "thin"
          },
          elements: {
              point:{
                  radius: 0,
                  hitRadius: 2
              }
          },
          scales: {
              xAxes: [{
                  scaleLabel: {
                      display: true,
                      labelString: "Date"
                  },
                  ticks: {
                      autoSkip: true,
                      autoSkipPadding: 20,
                      maxRotation: 0,
                      minRotation: 0,
                      fontSize: 13
                  },
                  gridLines: { display: false }

              }],
              yAxes: [{
                  scaleLabel: {
                      display: false,
                      // labelString: "Death (Total)"
                  },
                  gridLines: {
                    borderDash: [4,3],
                    color: "#a9a9a9"
                  }
              }]
          },
          legend: {
            position: "top",
            display: false
          },

          tooltips: {
            // mode: "index"
            enabled: false,
            custom: tooltip
          }
        }
      }
    }

    let death = new Chart(deathChart, chartDefaults("Deaths (Total)"))
    let hospitalizations = new Chart(hospitalizationsChart, chartDefaults("Hospitalizations (Daily)"))

    function getJson(folderName, commit, state, intervention, fips = null) {
      console.log(folderName, commit)
      let url = '/public/data/' + folderName + "/" + commit + '/' + state + '.json'
      if (folderName == "projections") url = '/public/data/' + folderName + "/" + commit + '/' + intervention + '/' + state  + '.json'
      if (folderName == "actual") url = '/public/data/actual/' + state  + '.json'
      if (folderName == "actual/fips") url = '/public/data/actual/fips/' + fips  + '.json' // state is
      // if (folderName == "CDC" && commit == "r--high") url = "/public/data/cdc/higher/" + state + ".json";
      // if (folderName == "CDC" && commit == "--lowe") url = "/public/data/cdc/lower/" + state + ".json";

      console.log("fetching", url)
      return fetch(url).then(data => data.json())
    }

    function pullData (folderName, commit, state, intervention, fips = null) {
      return Promise.all([getJson(folderName, commit, state, intervention, fips)]);
    }

    let firstSubmission = true;
    let listIndex = 1;

    function addData() {
      // console.log(
      //   "state:",
      //   statesSelect.value, // state abbreviation or "US"
      //   "fips:",
      //   countiesSelect.value, // fips or -1 for (all)
      //   "model:",
      //   modelsToShow[modelsSelect.value], // model object
      //   "intervention:",
      //   interventionSelect.value // index value
      // )
      statesSelect.disabled = true;
      countiesSelect.disabled = true;

      if (firstSubmission) {
        firstSubmission = false;
        if (statesSelect.value == "US") { // USA selected
          document.getElementById("location").innerHTML = "UNITED STATES"
          pullData("actual", null, "US", null)
            .then(act => {
              let datesArray = act[0].map(row => row.date)
              trueDates = datesArray;
              let deathArray = act[0].map(row => row.death)
              let hospArray = act[0].map(row => row.hospitalizations)

              death.options.title.text = "United States Deaths (Total)";
              hospitalizations.options.title.text = "United States Hospitalizations (Daily)"

              death.data.labels = convertDates(datesArray);
              hospitalizations.data.labels = convertDates(datesArray);
              death.data.datasets.push({
                label: "Actual",
                backgroundColor: colors[colorIndex],
                borderColor: colors[colorIndex],
                data: deathArray,
                fill: false,
                spanGaps: true
              });
              death.update();
              hospitalizations.data.datasets.push({
                label: "Actual",
                backgroundColor: colors[colorIndex],
                borderColor: colors[colorIndex],
                data: hospArray,
                fill: false,
                spanGaps: true
              });
              hospitalizations.update();
              addModelToLegend("Actual", 0, colors[colorIndex]);
              nextColor();

              let model = modelsToShow[modelsSelect.value]
              pullData(model.folderName, model.commitDate, "US", interventionSelect.value)
                .then(data => {

                  let deathArray = new Array(trueDates.length);
                  let hospArray = new Array(trueDates.length);

                  trueDates.forEach((label, index) => {
                    data[0].forEach(row => {
                      if (row.date == label && row.date >= model.commitDate) {
                        deathArray[index] = Math.round(row.death);
                        hospArray[index] = Math.round(row.hospitalizations);
                      }
                    })
                  })

                  let interventionText = interventions[interventionSelect.value]
                  let selectedIntervention = " " + interventionText;
                  if (interventionText == undefined) selectedIntervention = ""
                  let label = model.name + " " + model.commitDate + selectedIntervention;

                  death.data.datasets.push({
                    label: label,
                    backgroundColor: colors[colorIndex],
                    borderColor: colors[colorIndex],
                    data: deathArray,
                    fill: false,
                    spanGaps: true
                  });
                  death.update();

                  hospitalizations.data.datasets.push({
                    label: label,
                    backgroundColor: colors[colorIndex],
                    borderColor: colors[colorIndex],
                    data: hospArray,
                    fill: false,
                    spanGaps: true
                  });
                  hospitalizations.update();
                  addModelToLegend(label, listIndex, colors[colorIndex])
                  nextColor();
                })
            }).catch(err => console.log(err))
        } else if (countiesSelect.value == -1) { // state selected

          let state = statesSelect.value;
          document.getElementById("location").innerHTML = states[state].toUpperCase();

          // function pullData (folderName, commit, state, intervention)

          pullData("actual", null, state, null)
            .then(act => {
              let datesArray = act[0].map(row => row.date)
              trueDates = datesArray;
              let deathArray = act[0].map(row => row.death)
              let hospArray = act[0].map(row => row.hospitalizations)

              death.options.title.text = states[state] + " Deaths (Total)";
              hospitalizations.options.title.text = states[state] + " Hospitalizations (Daily)"

              death.data.labels = convertDates(datesArray);
              hospitalizations.data.labels = convertDates(datesArray);
              death.data.datasets.push({
                label: "Actual",
                backgroundColor: colors[colorIndex],
                borderColor: colors[colorIndex],
                data: deathArray,
                fill: false,
                spanGaps: true
              });
              death.update();
              hospitalizations.data.datasets.push({
                label: "Actual",
                backgroundColor: colors[colorIndex],
                borderColor: colors[colorIndex],
                data: hospArray,
                fill: false,
                spanGaps: true
              });
              hospitalizations.update();
              addModelToLegend("Actual", 0, colors[colorIndex]);
              nextColor();

              let model = modelsToShow[modelsSelect.value]

              pullData(model.folderName, model.commitDate, state, interventionSelect.value)
                .then(data => {

                  let deathArray = new Array(trueDates.length);
                  let hospArray = new Array(trueDates.length);

                  trueDates.forEach((label, index) => {
                    data[0].forEach(row => {
                      if (row.date == label && row.date >= model.commitDate) {
                        deathArray[index] = Math.round(row.death);
                        hospArray[index] = Math.round(row.hospitalizations);
                      }
                    })
                  })


                  let interventionText = interventions[interventionSelect.value]
                  let selectedIntervention = " " + interventionText;
                  if (interventionText == undefined) selectedIntervention = ""
                  let label = model.name + " " + model.commitDate + selectedIntervention;

                  death.data.datasets.push({
                    label: label,
                    backgroundColor: colors[colorIndex],
                    borderColor: colors[colorIndex],
                    data: deathArray,
                    fill: false,
                    spanGaps: true
                  });
                  death.update();

                  hospitalizations.data.datasets.push({
                    label: label,
                    backgroundColor: colors[colorIndex],
                    borderColor: colors[colorIndex],
                    data: hospArray,
                    fill: false,
                    spanGaps: true
                  });
                  hospitalizations.update();

                  addModelToLegend(label, listIndex, colors[colorIndex])
                  nextColor();


                })
            }).catch(err => console.log(err))

        } else { // county selected

          let fipsSelected = countiesSelect.value;
          let state = statesSelect.value;
          let modelSelectedTest = modelsSelect.value;
          // console.log(modelSelectedTest);
          let countyName = "";

          fips[state].forEach(county => {
            if (county.fips == fipsSelected) {
              countyName = county.name;
              document.getElementById("location").innerHTML = county.name.toUpperCase();
            }
          })

          pullData("actual/fips", null, null, null, fipsSelected)
            .then(act => {
              let datesArray = act[0].map(row => row.date)
              trueDates = datesArray;
              let deathArray = act[0].map(row => row.death)
              // let hospArray = act[0].map(row => row.cases)
              let hospArray = []

              death.options.title.text = countyName + ", " + states[statesSelect.value] + " Deaths (Total)";
              hospitalizations.options.title.text = countyName + ", " + states[statesSelect.value] + " Hospitalizations (Daily)"

              death.data.labels = convertDates(datesArray);
              hospitalizations.data.labels = convertDates(datesArray);
              death.data.datasets.push({
                label: "Actual",
                backgroundColor: colors[colorIndex],
                borderColor: colors[colorIndex],
                data: deathArray,
                fill: false,
                spanGaps: true
              });
              death.update();
              hospitalizations.data.datasets.push({
                label: "Actual",
                backgroundColor: colors[colorIndex],
                borderColor: colors[colorIndex],
                data: hospArray,
                fill: false,
                spanGaps: true
              });
              hospitalizations.update();
              addModelToLegend("Actual", 0, colors[colorIndex]);
              nextColor();

              let model = modelsToShow[modelsSelect.value]

              let snapshot = snapShotDates[model.commitDate]

// https://data.covidactnow.org/snapshot/398/us/counties/06019.STRONG_INTERVENTION.timeseries.json (EXAMPLE)
              fetch("https://data.covidactnow.org/snapshot/" + snapshot + "/us/counties/" + addLeadingZero(fipsSelected) + "." + canApiInterventions[interventionSelect.value] + ".timeseries.json")
                .then(data => data.json())
                .then(json => {
                  // console.log(json)
                  let projectionArray = json.timeseries.map(row => {
                    return {
                      date: parseDate(row.date),
                      death: row.cumulativeDeaths || 0
                    }
                  })
                  deathArray = new Array(trueDates.length);
                  hospArray = new Array(trueDates.length);

                  trueDates.forEach((label, index) => {
                    projectionArray.forEach(row => {
                      if (row.date == label && row.date >= model.commitDate) {
                        deathArray[index] = Math.round(row.death);
                        hospArray[index] = Math.round(row.hospitalizations);
                      }
                    })
                  })

                  // console.log(deathArray)

                  let interventionText = interventions[interventionSelect.value]
                  let selectedIntervention = " " + interventionText;
                  if (interventionText == undefined) selectedIntervention = ""
                  let label = model.name + " " + model.commitDate + selectedIntervention;

                  death.data.datasets.push({
                    label: label,
                    backgroundColor: colors[colorIndex],
                    borderColor: colors[colorIndex],
                    data: deathArray,
                    fill: false,
                    spanGaps: true
                  });
                  death.update();

                  hospitalizations.data.datasets.push({
                    label: label,
                    backgroundColor: colors[colorIndex],
                    borderColor: colors[colorIndex],
                    data: hospArray,
                    fill: false,
                    spanGaps: true
                  });
                  hospitalizations.update();
                  addModelToLegend(label, listIndex, colors[colorIndex])
                  nextColor();
                }).catch(err => {
                  errorMessage.innerHTML = errMsg;
                  console.log(err, "HERE!")

                })
            }).catch(err => console.log(err))
        }
      } else {
        firstSubmission = false;
        if (statesSelect.value == "US") { // USA selected
            let model = modelsToShow[modelsSelect.value]
            pullData(model.folderName, model.commitDate, "US", interventionSelect.value)
              .then(data => {
                let deathArray = new Array(trueDates.length);
                let hospArray = new Array(trueDates.length);

                trueDates.forEach((label, index) => {
                  data[0].forEach(row => {
                    if (row.date == label && row.date >= model.commitDate) {
                      deathArray[index] = Math.round(row.death);
                      hospArray[index] = Math.round(row.hospitalizations);
                    }
                  })
                })

                let interventionText = interventions[interventionSelect.value]
                let selectedIntervention = " " + interventionText;
                if (interventionText == undefined) selectedIntervention = ""
                let label = model.name + " " + model.commitDate + selectedIntervention;

                death.data.datasets.push({
                  label: label,
                  backgroundColor: colors[colorIndex],
                  borderColor: colors[colorIndex],
                  data: deathArray,
                  fill: false,
                  spanGaps: true
                });
                death.update();

                hospitalizations.data.datasets.push({
                  label: label,
                  backgroundColor: colors[colorIndex],
                  borderColor: colors[colorIndex],
                  data: hospArray,
                  fill: false,
                  spanGaps: true
                });
                hospitalizations.update();
                addModelToLegend(label, listIndex, colors[colorIndex])
                nextColor();

              })
        } else if (countiesSelect.value == -1) { // state selected

          let state = statesSelect.value;

          let model = modelsToShow[modelsSelect.value]

          pullData(model.folderName, model.commitDate, state, interventionSelect.value)
            .then(data => {

              let deathArray = new Array(trueDates.length);
              let hospArray = new Array(trueDates.length);

              trueDates.forEach((label, index) => {
                data[0].forEach(row => {
                  if (row.date == label && row.date >= model.commitDate) {
                    deathArray[index] = Math.round(row.death);
                    hospArray[index] = Math.round(row.hospitalizations);
                  }
                })
              })

              let interventionText = interventions[interventionSelect.value]
              let selectedIntervention = " " + interventionText;
              if (interventionText == undefined) selectedIntervention = ""
              let label = model.name + " " + model.commitDate + selectedIntervention;

              death.data.datasets.push({
                label: label,
                backgroundColor: colors[colorIndex],
                borderColor: colors[colorIndex],
                data: deathArray,
                fill: false,
                spanGaps: true
              });
              death.update();

              hospitalizations.data.datasets.push({
                label: label,
                backgroundColor: colors[colorIndex],
                borderColor: colors[colorIndex],
                data: hospArray,
                fill: false,
                spanGaps: true
              });
              hospitalizations.update();
              addModelToLegend(label, listIndex, colors[colorIndex])
              nextColor();

            })


        } else { // county selected
          let fipsSelected = countiesSelect.value;
          let state = statesSelect.value;
          let countyName = "";

          fips[state].forEach(county => {
            if (county.fips == fipsSelected) document.getElementById("location").innerHTML = county.name.toUpperCase();
          })

          // load county data onto graph here (not first submission)

          let model = modelsToShow[modelsSelect.value]
          let snapshot = snapShotDates[model.commitDate]

          fetch("https://data.covidactnow.org/snapshot/" + snapshot + "/us/counties/" + addLeadingZero(fipsSelected) + "." + canApiInterventions[interventionSelect.value] + ".timeseries.json")
          // fetch("https://data.covidactnow.org/latest/us/counties/" + addLeadingZero(fipsSelected) + "." + canApiInterventions[interventionSelect.value] + ".timeseries.json")
            .then(data => data.json())
            .then(json => {
              let projectionArray = json.timeseries.map(row => {
                return {
                  date: parseDate(row.date),
                  death: row.cumulativeDeaths || 0
                }
              })
              let deathArray = new Array(trueDates.length);
              let hospArray = new Array(trueDates.length);

              trueDates.forEach((label, index) => {
                projectionArray.forEach(row => {
                  if (row.date == label && row.date >= model.commitDate) {
                    deathArray[index] = Math.round(row.death);
                    hospArray[index] = Math.round(row.hospitalizations);
                  }
                })
              })

              let interventionText = interventions[interventionSelect.value]
              let selectedIntervention = " " + interventionText;
              if (interventionText == undefined) selectedIntervention = ""
              let label = model.name + " " + model.commitDate + selectedIntervention;

              death.data.datasets.push({
                label: label,
                backgroundColor: colors[colorIndex],
                borderColor: colors[colorIndex],
                data: deathArray,
                fill: false,
                spanGaps: true
              });
              death.update();

              hospitalizations.data.datasets.push({
                label: label,
                backgroundColor: colors[colorIndex],
                borderColor: colors[colorIndex],
                data: hospArray,
                fill: false,
                spanGaps: true
              });
              hospitalizations.update();
              addModelToLegend(label, listIndex, colors[colorIndex])
              nextColor();
            }).catch(err => console.log(err))
        }
      }
    }

    function addModelToLegend(name, index, color) {
      console.log(color);
      var ul = document.getElementById("legend");
      var li = document.createElement("li");
      // let liHtml = '<input type="checkbox" class="checkbox" checked onchange=check(this)>' + name + '<input type="color"><i class="material-icons">keyboard_arrow_down</i></input>'
      let liHtml = '<input type="checkbox" class="checkbox" checked onchange=check(this) />' + name + '<input class="colorBox" type="color" value=' + color + ' onchange="changeColor(this)" />'
      li.innerHTML = liHtml;
      // li.appendChild(document.createTextNode(name));
      li.setAttribute("id", index); // added line
      ul.appendChild(li);
      listIndex++
    }

    function emptyChart(chart) {
      // firstSubmission = true;
      // if (chart == death) {
      //   chart.options.title.text = "Deaths (Total)";
      // } else if (chart == hospitalizations) {
      //   chart.options.title.text = "Hospitalizations (Total)";
      // }
      //
      // chart.data.labels = ['Mar 01', 'Apr 01', 'May 01', 'Jun 01'];
      // chart.data.datasets = [];
      // chart.update();
      location.reload();
    }

    function emptyCharts() {
      emptyChart(death)
      emptyChart(hospitalizations)

      statesSelect.disabled = false;
      countiesSelect.disabled = true;
      modelsSelect.disabled = true;
      interventionSelect.disabled = true;
      submitButton.disabled = true;

      // TO DO DELETE LIST ELEMENTS TOO!

      document.getElementById("location").innerHTML = "NONE";

      let legend = document.getElementById("legend");
      while(legend.firstChild){
        legend.removeChild(legend.firstChild);
      }

      colorIndex = 0;



    }



    function check(checkbox) {
      let displayGraph = checkbox.checked;
      let li = checkbox.parentNode
      let ul = li.parentNode
      let ulList = Array.from(ul.children)
      let checkIndex = ulList.indexOf(li);

      death.data.datasets.forEach((ds, index) => {
        if (index == checkIndex) {
          ds.hidden = !ds.hidden
        }
      })
      death.update();

      hospitalizations.data.datasets.forEach((ds, index) => {
        if (index == checkIndex) {
          ds.hidden = !ds.hidden
        }
      })
      hospitalizations.update();

    }

    function changeColor(col) {
      let li = col.parentNode;
      let ul = li.parentNode
      let ulList = Array.from(ul.children)
      let colorIndex = ulList.indexOf(li);

      death.data.datasets.forEach((ds, index) => {
        if (index == colorIndex) {
          ds.backgroundColor = col.value;
          ds.borderColor = col.value
        }
      })
      death.update();

      hospitalizations.data.datasets.forEach((ds, index) => {
        if (index == colorIndex) {
          ds.backgroundColor = col.value;
          ds.borderColor = col.value
        }
      })
      hospitalizations.update();
    }


    function tooltip (tooltipModel) {
      // Tooltip Element
      var tooltipEl = document.getElementById('chartjs-tooltip');

      // Create element on first render
      if (!tooltipEl) {
          tooltipEl = document.createElement('div');
          tooltipEl.id = 'chartjs-tooltip';
          tooltipEl.innerHTML = '<table></table>';
          document.body.appendChild(tooltipEl);
      }

      // Hide if no tooltip
      if (tooltipModel.opacity === 0) {
          tooltipEl.style.opacity = 0;
          return;
      }

      // Set caret Position
      tooltipEl.classList.remove('above', 'below', 'no-transform');
      if (tooltipModel.yAlign) {
          tooltipEl.classList.add(tooltipModel.yAlign);
      } else {
          tooltipEl.classList.add('no-transform');
      }

      function getBody(bodyItem) {
          return bodyItem.lines;
      }

      // Set Text
      if (tooltipModel.body) {
          var titleLines = tooltipModel.title || [];
          var bodyLines = tooltipModel.body.map(getBody);
          let bodyArray = bodyLines[0][0].replace(/\:/g, '').split(" ")
          let modelName = bodyArray[0]
          let value = Number(bodyArray[bodyArray.length - 1])
          bodyArray.pop();
          let modelString = bodyArray.join(" ");
          let datasets = this._data.datasets;
          let datasetIndex = tooltipModel.dataPoints[0].datasetIndex;
          let dataIndex = tooltipModel.dataPoints[0].index;
          let title = this._chart.chart.options.title.text;

          let dataset = datasets[datasetIndex].data;
          let actuals = datasets[0].data;
          // console.log(dataset)
          let startIndex = 0;
          dataset.find((el, index) => {
            return (typeof (el) != "undefined")
          })

          // console.log(startIndex)
          let cumulativeActuals = cumulativeMaker(actuals, startIndex);
          let cumulativeDataset = cumulativeMaker(dataset, startIndex);

          var innerHtml = '<thead>';

          titleLines.forEach(function(title) {
              innerHtml += '<tr><th>' + title + " (" + modelString + ')</th></tr>';
          });
          innerHtml += '</thead><tbody>';

          let valueTitles = ["Count: ", "Margin of Error: ", "Cumulative Margin of Error: "]
          let values = [value]; // index 0 is actual #
          values[1] = value - actuals[dataIndex] || 0; // index 1 is MOE of that point
          // values[2] = cumulativeDataset[dataIndex] - cumulativeActuals[dataIndex] || 0; // index 2 is MOE cumulative

          values.forEach(function(value, index) {
              innerHtml +=
                '<tr><td>' +
                valueTitles[index] +
                value + '</td></tr>';
          });
          innerHtml += '</tbody>';

          var tableRoot = tooltipEl.querySelector('table');
          tableRoot.innerHTML = innerHtml;
      }

      // `this` will be the overall tooltip
      var position = this._chart.canvas.getBoundingClientRect();

      // Display, position, and set styles for font
      tooltipEl.style.opacity = 0.9;
      tooltipEl.style.position = 'absolute';
      tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
      tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
      tooltipEl.style.fontFamily = tooltipModel._bodyFontFamily;
      tooltipEl.style.fontSize = tooltipModel.bodyFontSize - 1 + 'px';
      tooltipEl.style.fontStyle = tooltipModel._bodyFontStyle;
      tooltipEl.style.padding = tooltipModel.yPadding + 'px ' + tooltipModel.xPadding + 'px';
      tooltipEl.style.pointerEvents = 'none';
      tooltipEl.style.backgroundColor = 'black';
      tooltipEl.style.color = 'white';
      tooltipEl.style.width = "300px"
      }


      function downloadCsv() {
        let csvArray = [];
        csvArray[0] = ["DATE"];
        let deathData = death.tooltip._data.datasets
        let hospitalizationData = hospitalizations.tooltip._data.datasets;
        deathData.forEach((dataset, index) => {
          csvArray[0].push(dataset.label + " DEATH");
          if (index > 0) csvArray[0].push(dataset.label + " DEATH MARGIN OF ERROR");
          csvArray[0].push(hospitalizationData[index].label + " HOSPITALIZATION");
          if (index > 0) csvArray[0].push(hospitalizationData[index].label + " HOSPITALIZATION MARGIN OF ERROR");
        })
        // csvArray[0][1] is "Actual DEATH"
        // csvArray[0][2] is "Actual HOSPITALIZATION"
        // csvArray[0][3] is "X PREDICTED DEATH"
        // csvArray[0][4] is "X PREDICTED DEATH MARGIN OF ERROR"
        // csvArray[0][5] is "X PREDICTED HOSPITALIZATIONS"
        // csvArray[0][6] is "X PREDICTED HOSPITALIZATIONS MARGIN OF ERROR"
        // csvArray[1][0] is date (start)

        trueDates.forEach(date => csvArray.push([date]));

        deathData[0].data.forEach((data, index) => {
          csvArray[index+1][1] = data || 0;
        });
        hospitalizationData[0].data.forEach((data, index) => {
          csvArray[index+1][2] = data || 0;
        });

        deathData.forEach((dataset, i) => {
          if (i > 0) {

            trueDates.forEach((date, j) => {
              let counter = 3 + 4*(i-1);
              let currentDeathData = dataset.data[j];
              if (currentDeathData == undefined) currentDeathData = 0
              let currentHospitalizationData = hospitalizationData[i].data[j];
              if (currentHospitalizationData == undefined) currentHospitalizationData = 0

              csvArray[j+1][counter] = currentDeathData || 0;
              counter++;
              csvArray[j+1][counter] = currentDeathData - csvArray[j+1][1];
              counter++;
              csvArray[j+1][counter] = currentHospitalizationData || 0;
              counter++;
              csvArray[j+1][counter] = currentHospitalizationData - csvArray[j+1][2];
              counter = 3 + 4*(i-1);
            })
          }
        });

        let csv = ""
        csvArray.forEach(rowArray => {
          let row = rowArray.join(",")
          csv += row + "\n";
        });

        let hiddenElement = document.createElement("a");
        hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
        hiddenElement.target = "_blank";
        hiddenElement.download = death.tooltip._chartInstance.tooltip._chart.options.title.text + ".csv";
        hiddenElement.click();
      }

  </script>
</html>
